# handlers/weather_handler.py
from logger_config import get_logger
from modules.weather import get_formatted_current_weather, get_formatted_forecast, get_formatted_weather_by_coords

logger = get_logger()

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–º–µ–Ω—ã/–¥–µ–π—Å—Ç–≤–∏–π, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–∑ bot.py
get_weather_inline_keyboard_func = None
def set_weather_inline_keyboard_func(func):
    global get_weather_inline_keyboard_func
    get_weather_inline_keyboard_func = func

def handle_weather_callback(data, chat_id, message_id, user_id, user_states, send_message_func, edit_message_text_func, get_weather_keyboard_func):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–æ–≥–æ–¥–æ–π."""
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞
    if get_weather_keyboard_func:
        set_weather_inline_keyboard_func(get_weather_keyboard_func)

    if data == 'weather_menu':
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É –∏ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        import asyncio
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º run_until_complete –¥–ª—è –≤—ã–∑–æ–≤–∞ async —Ñ—É–Ω–∫—Ü–∏–∏
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            weather_text = loop.run_until_complete(get_formatted_current_weather(user_id))
        finally:
            loop.close()

        keyboard = get_weather_inline_keyboard_func() if get_weather_inline_keyboard_func else None
        send_message_func(chat_id, weather_text, keyboard)

    elif data == 'weather_forecast_3days':
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è
        import asyncio
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            forecast_text = loop.run_until_complete(get_formatted_forecast(user_id))
        finally:
            loop.close()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –∫–∞–∫ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        send_message_func(chat_id, forecast_text, get_weather_inline_keyboard_func() if get_weather_inline_keyboard_func else None)

    elif data == 'weather_by_location':
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        keyboard = {"keyboard": [[{"text": "üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ", "request_location": True}]], "resize_keyboard": True, "one_time_keyboard": True}
        send_message_func(chat_id, "üìç –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:", keyboard)

    elif data == 'weather_back_to_main':
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        from bot import get_main_reply_keyboard # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ bot.py
        send_message_func(chat_id, "–ì–ªa–≤–Ω–æ–µ –º–µ–Ω—é:", get_main_reply_keyboard())


def handle_weather_message_input(text, chat_id, user_id, user_states, send_message_func, edit_message_text_func, get_weather_keyboard_func):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –ø–æ–≥–æ–¥—ã."""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
    # –í bot.py –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å location –æ—Ç–¥–µ–ª—å–Ω–æ –∏–ª–∏ –ø–∞—Ä—Å–∏—Ç—å –∏–∑ message
    # –ü–æ–∫–∞ —á—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç. –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –≤ bot.py –Ω–∞–ø—Ä—è–º—É—é
    # –∏ –≤—ã–∑—ã–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–¥–µ—Å—å.

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–∫—Å—Ç "üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–π,
    # —ç—Ç–æ –Ω–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è, –∞ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç. –ù–∞—Å—Ç–æ—è—â–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è - —ç—Ç–æ –æ–±—ä–µ–∫—Ç message.location
    # –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –≤ bot.py.

    # –í –¥–∞–Ω–Ω–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–≥–æ–¥—ã –æ—Å–æ–±–æ –¥–µ–ª–∞—Ç—å –Ω–µ—á–µ–≥–æ,
    # –∫—Ä–æ–º–µ –∫–∞–∫ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–∑–∞–±–ª—É–¥–∏–ª—Å—è".
    # –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –Ω–∞–∂–∞–ª "–ü–æ–≥–æ–¥–∞", –ø–æ–ª—É—á–∏–ª inline-–∫–Ω–æ–ø–∫–∏, –Ω–æ –≤–º–µ—Å—Ç–æ –Ω–∏—Ö –Ω–∞—á–∞–ª –ø–µ—á–∞—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç.

    current_state = user_states.get((user_id, chat_id))
    if current_state and current_state.startswith("waiting_for_weather_"):
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å –ø–æ–≥–æ–¥–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±—ã –±—ã–ª–∞ —Ç–∞–∫–∞—è –ª–æ–≥–∏–∫–∞)
        # –°–µ–π—á–∞—Å —Ç–∞–∫–æ–π –ª–æ–≥–∏–∫–∏ –Ω–µ—Ç, –Ω–æ –Ω–∞ –±—É–¥—É—â–µ–µ –æ—Å—Ç–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É.
        pass # –ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    # logger.warning(f"–ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –º–æ–¥—É–ª–µ –ø–æ–≥–æ–¥—ã –æ—Ç user_id {user_id}: {text}")
    # send_message_func(chat_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤ –º–æ–¥—É–ª–µ –ø–æ–≥–æ–¥—ã. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", get_weather_inline_keyboard_func() if get_weather_inline_keyboard_func else None)
    # –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å, –∫–∞–∫ –∏ –∑–∞–¥—É–º–∞–Ω–æ –¥–ª—è inline-–º–µ–Ω—é.


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–Ω–æ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ bot.py)
def handle_weather_location(user_id, chat_id, latitude, longitude, send_message_func):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏."""
    try:
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ—Ç user_id {user_id}: {latitude}, {longitude}")

        import asyncio
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            weather_text = loop.run_until_complete(get_formatted_weather_by_coords(user_id, latitude, longitude))
        finally:
            loop.close()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–≥–æ–¥—É –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        # –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–≥–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–≥–æ–¥—ã
        keyboard = get_weather_inline_keyboard_func() if get_weather_inline_keyboard_func else None
        send_message_func(chat_id, weather_text, keyboard)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è user_id {user_id}: {e}")
        send_message_func(chat_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é.", get_weather_inline_keyboard_func() if get_weather_inline_keyboard_func else None)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞)
async def trigger_daily_notification(user_id, send_message_func):
    """–¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–≥–æ–¥–µ."""
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º
    # –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å async, —Ç–∞–∫ –∫–∞–∫ –≤—ã–∑—ã–≤–∞–µ—Ç async —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ modules/weather.py
    from modules.weather import send_daily_weather_notification
    await send_daily_weather_notification(user_id, send_message_func)