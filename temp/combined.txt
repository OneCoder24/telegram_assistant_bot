

=== base_handler.txt ===

# handlers/base_handler.py
from logger_config import get_logger
from modules.notes import get_all_notes, format_notes_list
from modules.tasks import get_all_tasks, format_tasks_list # –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –¥–ª—è –∑–∞–¥–∞—á
from modules.reminders import get_all_reminders, format_reminders_list # –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
from handlers.notes_handler import handle_notes_callback, handle_notes_message_input
from handlers.tasks_handler import handle_tasks_callback, handle_tasks_message_input # –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–¥–∞—á
from handlers.reminders_handler import handle_reminders_callback, handle_reminders_message_input # –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
from database import get_db

logger = get_logger()
db = get_db()

def handle_main_menu_reply(chat_id, user_id, text, user_states): # user_id —É–∂–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ reply-–∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è (user_id, chat_id) –∫–∞–∫ –∫–ª—é—á
    # –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    temp_text_key_add = (user_id, chat_id, 'temp_task_text_for_add')
    current_state = user_states.pop((user_id, chat_id), None)
    temp_text = user_states.pop(temp_text_key_add, None)
    if current_state:
        logger.info(f"–î–µ–π—Å—Ç–≤–∏–µ {current_state} –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} —á–µ—Ä–µ–∑ reply-–∫–Ω–æ–ø–∫—É.")
    if temp_text:
        logger.info(f"–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ ({temp_text}) —Å–±—Ä–æ—à–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} —á–µ—Ä–µ–∑ reply-–∫–Ω–æ–ø–∫—É.")

    # --- –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è ---
    if text == "üìù –ó–∞–º–µ—Ç–∫–∏":
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_notes
        notes = get_all_notes(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        notes_text = format_notes_list(notes)
        return notes_text, "notes_keyboard"
    elif text == "‚úÖ –ó–∞–¥–∞—á–∏": # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_tasks
        tasks = get_all_tasks(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        tasks_text = format_tasks_list(tasks)
        return tasks_text, "tasks_keyboard"
    elif text == "‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è": # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_reminders
        reminders = get_all_reminders(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        reminders_text = format_reminders_list(reminders)
        return reminders_text, "reminders_keyboard"
    elif text == "üå§Ô∏è –ü–æ–≥–æ–¥–∞":
        return "–ú–æ–¥—É–ª—å –ø–æ–≥–æ–¥—ã (–∑–∞–≥–ª—É—à–∫–∞).", "weather_keyboard"
    elif text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏":
        return "–ú–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–∑–∞–≥–ª—É—à–∫–∞).", "settings_keyboard"

    return None, None # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç

def handle_callback_query(callback_query, user_states, user_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—è –ø–æ –º–æ–¥—É–ª—è–º."""
    data = callback_query["data"]
    chat_id = callback_query["message"]["chat"]["id"]
    message_id = callback_query["message"]["message_id"]
    # user_id = callback_query["from"]["id"] # <-- –£–ë–†–ê–ù–û, —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç

    logger.info(f"–ü–æ–ª—É—á–µ–Ω callback_query –æ—Ç {user_id}: {data}")

    # –ï—Å–ª–∏ callback_data –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∑–∞–º–µ—Ç–∫–∞–º, –ø–µ—Ä–µ–¥–∞—ë–º –≤ notes_handler
    if data.startswith(("edit_note_", "delete_note_", "add_note_prompt", "notes_menu")):
        return "notes", data

    # –ï—Å–ª–∏ callback_data –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∑–∞–¥–∞—á–∞–º, –ø–µ—Ä–µ–¥–∞—ë–º –≤ tasks_handler
    if data.startswith(("edit_task_", "keep_current_text_", "keep_current_deadline_", "toggle_task_status_", "delete_task_", "add_task_prompt", "tasks_menu")): # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        return "tasks", data

    # –ï—Å–ª–∏ callback_data –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º, –ø–µ—Ä–µ–¥–∞—ë–º –≤ reminders_handler
    if data.startswith(("toggle_reminder_type_", "delete_reminder_", "add_reminder_prompt", "reminders_menu")): # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        return "reminders", data

    elif data == 'main_menu':
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∏ —Ç–∏–ø –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        return "main_menu", ("–ì–ªa–≤–Ω–æ–µ –º–µ–Ω—é:", "main_keyboard")

    return None, None # –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ base_handler

def handle_message_input(message, user_states, user_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—è –ø–æ –º–æ–¥—É–ª—è–º."""
    text = message.get("text", "")
    chat_id = message["chat"]["id"]
    # user_id = message["from"]["id"] # <-- –£–ë–†–ê–ù–û, —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç

    # --- –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏–µ–º reply-–∫–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é ---
    if text in ["üìù –ó–∞–º–µ—Ç–∫–∏", "‚úÖ –ó–∞–¥–∞—á–∏", "‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", "üå§Ô∏è –ü–æ–≥–æ–¥–∞", "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"]: # <-- "‚úÖ –ó–∞–¥–∞—á–∏" –∏ "‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è" –¥–æ–±–∞–≤–ª–µ–Ω—ã
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ base_handler
        text_to_send, keyboard_type = handle_main_menu_reply(chat_id, user_id, text, user_states)
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∏–ø –º–µ–Ω—é –∏ (text, keyboard_type)
        if text_to_send is not None:
            return "main_reply", (text_to_send, keyboard_type)
        else:
            # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
            return None, None

    # --- –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ ---
    current_state = user_states.get((user_id, chat_id))
    if current_state and current_state.startswith("waiting_for_note_"):
        # –ü–µ—Ä–µ–¥–∞—ë–º –≤ notes_handler
        return "notes", text
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –∑–∞–¥–∞—á
    if current_state and current_state.startswith("waiting_for_task_"): # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        # –ü–µ—Ä–µ–¥–∞—ë–º –≤ tasks_handler
        return "tasks", text
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    if current_state and current_state.startswith("waiting_for_reminder_"): # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
        # –ü–µ—Ä–µ–¥–∞—ë–º –≤ reminders_handler
        return "reminders", text

    # --- –ü–†–ò–û–†–ò–¢–ï–¢ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start ---
    if text == "/start":
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∏ —Ç–∏–ø –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        return "start", ("–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –≤–∞—à –ª–∏—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.", "main_keyboard")

    return None, None # –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ

---


=== bot.txt ===

# bot.py
import requests
import json
import time
import threading # <-- –î–û–ë–ê–í–õ–ï–ù–û
from datetime import datetime, timedelta # <-- –î–û–ë–ê–í–õ–ï–ù–û
from config import BOT_TOKEN
from logger_config import get_logger
from handlers.base_handler import handle_callback_query, handle_message_input
from handlers.notes_handler import handle_notes_callback, handle_notes_message_input, set_cancel_keyboard_func
from handlers.tasks_handler import handle_tasks_callback, handle_tasks_message_input, set_cancel_keyboard_func as set_cancel_keyboard_func_tasks, set_keep_current_text_keyboard_func, set_keep_current_deadline_keyboard_func # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∑–∞–¥–∞—á
from handlers.reminders_handler import handle_reminders_callback, handle_reminders_message_input, set_cancel_keyboard_func as set_cancel_keyboard_func_reminders # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
from modules.notes import get_all_notes
from modules.tasks import get_all_tasks # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
from modules.reminders import get_all_reminders, delete_reminder # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
from modules.reminders import format_reminders_list # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
from database import get_db # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

logger = get_logger()

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
BASE_URL = f"https://api.telegram.org/bot{BOT_TOKEN}"
OFFSET_FILE = "bot_offset.txt"

# --- –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º (user_id, chat_id) –∫–∞–∫ –∫–ª—é—á –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
user_states = {}

# --- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ---
# (–≠—Ç–æ –ø–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ - –¥–µ—Ä–∂–∞—Ç—å –∏—Ö —Ç—É—Ç. –ù—É–∂–Ω–æ –≤ keyboards/)
def get_main_reply_keyboard():
    keyboard = [[{"text": "üìù –ó–∞–º–µ—Ç–∫–∏"}, {"text": "‚úÖ –ó–∞–¥–∞—á–∏"}], [{"text": "‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"}, {"text": "üå§Ô∏è –ü–æ–≥–æ–¥–∞"}], [{"text": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"}]]
    return {"keyboard": keyboard, "resize_keyboard": True, "one_time_keyboard": False}

def get_notes_inline_keyboard(notes):
    keyboard = []
    if notes:
        for note in notes:
            note_row = [{"text": f"‚úèÔ∏è {note['id']}", "callback_data": f"edit_note_{note['id']}"},
                        {"text": f"üóëÔ∏è {note['id']}", "callback_data": f"delete_note_{note['id']}"}]
            keyboard.append(note_row)
    keyboard.append([{"text": "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É", "callback_data": "add_note_prompt"}])
    return {"inline_keyboard": keyboard}

def get_tasks_inline_keyboard(tasks): # <-- –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: 3 –∫–Ω–æ–ø–∫–∏
    keyboard = []
    if tasks:
        for task in tasks:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
            status_text = "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ" if task['is_completed'] else "‚è≥ –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
            status_callback = f"toggle_task_status_{task['id']}"
            # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ (—Ç–µ–ø–µ—Ä—å 3 –∫–Ω–æ–ø–∫–∏)
            task_row = [
                # –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ "‚úèÔ∏è [ID]" –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                {"text": f"‚úèÔ∏è {task['id']}", "callback_data": f"edit_task_{task['id']}"},
                {"text": status_text, "callback_data": status_callback},
                {"text": f"üóëÔ∏è {task['id']}", "callback_data": f"delete_task_{task['id']}"},
            ]
            keyboard.append(task_row)

    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    keyboard.append([
        {"text": "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", "callback_data": "add_task_prompt"}
    ])
    # –ö–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∞" —É–±—Ä–∞–Ω–∞

    return {"inline_keyboard": keyboard}

def get_reminders_inline_keyboard(reminders): # <-- –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    keyboard = []
    if reminders:
        for reminder in reminders:
            recurring_text = "üîÑ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ" if reminder['is_recurring'] else "üìÖ –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ"
            recurring_callback = f"toggle_reminder_type_{reminder['id']}"
            # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            reminder_row = [
                {"text": recurring_text, "callback_data": recurring_callback},
                {"text": f"üóëÔ∏è {reminder['id']}", "callback_data": f"delete_reminder_{reminder['id']}"},
            ]
            keyboard.append(reminder_row)

    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    keyboard.append([
        {"text": "‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", "callback_data": "add_reminder_prompt"}
    ])
    # –ö–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∞" —É–±—Ä–∞–Ω–∞

    return {"inline_keyboard": keyboard}

def get_cancel_inline_keyboard(target_menu="notes_menu"):
    return {"inline_keyboard": [[{"text": "‚ùå –û—Ç–º–µ–Ω–∞", "callback_data": target_menu}]]}

def get_keep_current_text_keyboard(task_id, target_menu="tasks_menu"):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π '–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç'. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ tasks_handler."""
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ tasks_handler
    # –û–Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏: "–û—Å—Ç–∞–≤–∏—Ç—å..." –∏ "‚ùå –û—Ç–º–µ–Ω–∞"
    # callback_data –¥–ª—è –ø–µ—Ä–≤–æ–π –∫–Ω–æ–ø–∫–∏: keep_current_text_{task_id}
    # callback_data –¥–ª—è –≤—Ç–æ—Ä–æ–π –∫–Ω–æ–ø–∫–∏: target_menu (–Ω–∞–ø—Ä–∏–º–µ—Ä, tasks_menu)
    return {"inline_keyboard": [[{"text": "–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç", "callback_data": f"keep_current_text_{task_id}"}], [{"text": "‚ùå –û—Ç–º–µ–Ω–∞", "callback_data": target_menu}]]}

def get_keep_current_deadline_keyboard(task_id, target_menu="tasks_menu"):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π '–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É'. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ tasks_handler."""
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ tasks_handler
    # –û–Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏: "–û—Å—Ç–∞–≤–∏—Ç—å..." –∏ "‚ùå –û—Ç–º–µ–Ω–∞"
    # callback_data –¥–ª—è –ø–µ—Ä–≤–æ–π –∫–Ω–æ–ø–∫–∏: keep_current_deadline_{task_id}
    # callback_data –¥–ª—è –≤—Ç–æ—Ä–æ–π –∫–Ω–æ–ø–∫–∏: target_menu (–Ω–∞–ø—Ä–∏–º–µ—Ä, tasks_menu)
    return {"inline_keyboard": [[{"text": "–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É", "callback_data": f"keep_current_deadline_{task_id}"}], [{"text": "‚ùå –û—Ç–º–µ–Ω–∞", "callback_data": target_menu}]]}

def get_weather_inline_keyboard():
    return {"inline_keyboard": [[{"text": "‚ùå –û—Ç–º–µ–Ω–∞", "callback_data": "main_menu"}]]}

# --- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è notes_handler, tasks_handler –∏ reminders_handler ---
set_cancel_keyboard_func(get_cancel_inline_keyboard)
set_cancel_keyboard_func_tasks(get_cancel_inline_keyboard) # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª—è –∑–∞–¥–∞—á
set_cancel_keyboard_func_reminders(get_cancel_inline_keyboard) # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã "–û—Å—Ç–∞–≤–∏—Ç—å..." –¥–ª—è tasks_handler
set_keep_current_text_keyboard_func(get_keep_current_text_keyboard)
set_keep_current_deadline_keyboard_func(get_keep_current_deadline_keyboard)

# --- –§–£–ù–ö–¶–ò–ò –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–ô ---
def send_message(chat_id, text, reply_markup=None, parse_mode=None): # <-- –î–æ–±–∞–≤–ª–µ–Ω parse_mode
    url = f"{BASE_URL}/sendMessage"
    payload = {"chat_id": chat_id, "text": text}
    if reply_markup:
        payload["reply_markup"] = json.dumps(reply_markup)
    if parse_mode: # <-- –î–æ–±–∞–≤–ª—è–µ–º parse_mode –≤ payload, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
        payload["parse_mode"] = parse_mode
    try:
        response = requests.post(url, json=payload)
        if not response.json().get("ok"):
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {response.json()}")
        return response.json()
    except requests.exceptions.RequestException as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        return None

def edit_message_text(chat_id, message_id, text, reply_markup=None, parse_mode=None): # <-- –î–æ–±–∞–≤–ª–µ–Ω parse_mode
    url = f"{BASE_URL}/editMessageText"
    payload = {"chat_id": chat_id, "message_id": message_id, "text": text}
    if reply_markup:
        payload["reply_markup"] = json.dumps(reply_markup)
    if parse_mode: # <-- –î–æ–±–∞–≤–ª—è–µ–º parse_mode –≤ payload, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
        payload["parse_mode"] = parse_mode
    try:
        response = requests.post(url, json=payload)
        if not response.json().get("ok"):
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {response.json()}")
    except requests.exceptions.RequestException as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

def answer_callback_query(callback_query_id, text=None):
    url = f"{BASE_URL}/answerCallbackQuery"
    payload = {"callback_query_id": callback_query_id}
    if text:
        payload["text"] = text
    try:
        requests.post(url, json=payload)
    except requests.exceptions.RequestException as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ callback_query: {e}")

# --- –ó–ê–ì–†–£–ó–ö–ê/–°–û–•–†–ê–ù–ï–ù–ò–ï OFFSET'–∞ ---
def load_offset():
    try:
        with open(OFFSET_FILE, "r") as f:
            return int(f.read().strip())
    except FileNotFoundError:
        return 0

def save_offset(offset):
    with open(OFFSET_FILE, "w") as f:
        f.write(str(offset))

# --- –ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô ---
def check_and_send_reminders(send_message_func, interval=30): # –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    """
    –ü–æ—Ç–æ–∫–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
    """
    logger.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω.")
    db_scheduler = get_db() # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DB –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    while True:
        try:
            now = datetime.now()
            # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Å—Ç—É–ø–∏–ª–æ
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ database.py
            due_reminders = db_scheduler.get_reminders_for_time_check(now)

            for reminder in due_reminders:
                # reminder_time = datetime.fromisoformat(reminder['remind_at']) # –£–∂–µ –µ—Å—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∑–∞–ø—Ä–æ—Å–∞
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ª–∏ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                # (–î–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è)
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º now-floor –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.
                check_time_floor = now - timedelta(seconds=interval)
                reminder_time = datetime.fromisoformat(reminder['remind_at'])
                if check_time_floor < reminder_time <= now:
                    user_id = reminder['user_id']
                    message_text = f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {reminder['text']}"
                    try:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        send_message_func(chat_id=user_id, text=message_text, reply_markup=None, parse_mode=None)
                        logger.info(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {reminder['text'][:30]}...")

                        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —É –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª—è–µ–º –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ
                        if reminder['is_recurring']:
                            # –û–±–Ω–æ–≤–ª—è–µ–º remind_at –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
                            next_reminder_time = reminder_time + timedelta(days=1)
                            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –∏–∑ db_manager –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            db_conn = db_scheduler.get_connection()
                            cursor = db_conn.cursor()
                            cursor.execute("UPDATE reminders SET remind_at = ? WHERE id = ? AND user_id = ?", (next_reminder_time.strftime('%Y-%m-%d %H:%M:%S'), reminder['id'], user_id))
                            db_conn.commit()
                            db_conn.close()
                            logger.debug(f"–í—Ä–µ–º—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder['id']}) –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ {next_reminder_time.strftime('%Y-%m-%d %H:%M:%S')}.")
                        else:
                            # –£–¥–∞–ª—è–µ–º –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ modules/reminders
                            success = delete_reminder(user_id, reminder['id'])
                            if success:
                                logger.debug(f"–û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (ID: {reminder['id']}) —É–¥–∞–ª–µ–Ω–æ –∏–∑ –ë–î.")
                            else:
                                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (ID: {reminder['id']}) –∏–∑ –ë–î.")

                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")

        # –ñ–¥–µ–º –∑–∞–¥–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        time.sleep(interval)

# --- –û–ë–†–ê–ë–û–¢–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–ô ---
def handle_update(update):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—è –ø–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º."""
    if "callback_query" in update:
        callback_query = update["callback_query"]
        data = callback_query["data"]
        callback_query_id = callback_query["id"]
        answer_callback_query(callback_query_id)

        # –ò–∑–≤–ª–µ–∫–∞–µ–º user_id –∏–∑ callback_query
        user_id = callback_query["from"]["id"]
        chat_id = callback_query["message"]["chat"]["id"]
        message_id = callback_query["message"]["message_id"]

        module, result = handle_callback_query(callback_query, user_states, user_id)

        if module == "notes":
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id
            handle_notes_callback(data, chat_id, message_id, user_id, user_states, send_message, edit_message_text, get_notes_inline_keyboard)
        elif module == "tasks": # <-- –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞—á
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id
            handle_tasks_callback(data, chat_id, message_id, user_id, user_states, send_message, edit_message_text, get_tasks_inline_keyboard)
        elif module == "reminders": # <-- –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id
            handle_reminders_callback(data, chat_id, message_id, user_id, user_states, send_message, edit_message_text, get_reminders_inline_keyboard)
        elif module == "main_menu":
            text, keyboard_type = result
            if keyboard_type == "main_keyboard":
                keyboard = get_main_reply_keyboard()
            else:
                keyboard = None # –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç
            send_message(chat_id, text, keyboard)

    elif "message" in update:
        message = update["message"]
        text = message.get("text", "")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º user_id –∏–∑ message
        user_id = message["from"]["id"]
        chat_id = message["chat"]["id"]

        module, result = handle_message_input(message, user_states, user_id)

        if module == "notes":
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id
            handle_notes_message_input(text, chat_id, user_id, user_states, send_message, edit_message_text, get_notes_inline_keyboard)
        elif module == "tasks": # <-- –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∑–∞–¥–∞—á
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id
            handle_tasks_message_input(text, chat_id, user_id, user_states, send_message, edit_message_text, get_tasks_inline_keyboard)
        elif module == "reminders": # <-- –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id
            handle_reminders_message_input(text, chat_id, user_id, user_states, send_message, edit_message_text, get_reminders_inline_keyboard)
        elif module == "main_reply":
            text_to_send, keyboard_type = result # <-- –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –†–ê–°–ü–ê–ö–û–í–ö–ê
            # text_to_send = str
            # keyboard_type = str
            if keyboard_type == "notes_keyboard":
                # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_notes
                notes = get_all_notes(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
                keyboard = get_notes_inline_keyboard(notes)
            elif keyboard_type == "tasks_keyboard": # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∑–∞–¥–∞—á
                # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_tasks
                tasks = get_all_tasks(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
                keyboard = get_tasks_inline_keyboard(tasks)
            elif keyboard_type == "reminders_keyboard": # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
                # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_reminders
                reminders = get_all_reminders(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
                keyboard = get_reminders_inline_keyboard(reminders)
            elif keyboard_type == "tasks_keyboard":
                keyboard = get_main_reply_keyboard() # –ó–∞–≥–ª—É—à–∫–∞
            elif keyboard_type == "reminders_keyboard":
                keyboard = get_main_reply_keyboard() # –ó–∞–≥–ª—É—à–∫–∞
            elif keyboard_type == "weather_keyboard":
                keyboard = get_weather_inline_keyboard()
            elif keyboard_type == "settings_keyboard":
                keyboard = get_main_reply_keyboard() # –ó–∞–≥–ª—É—à–∫–∞
            elif keyboard_type == "main_keyboard":
                keyboard = get_main_reply_keyboard()
            else:
                keyboard = None # –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

            send_message(chat_id, text_to_send, keyboard)
        elif module == "start":
            text, keyboard_type = result # <-- –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –†–ê–°–ü–ê–ö–û–í–ö–ê
            if keyboard_type == "main_keyboard":
                keyboard = get_main_reply_keyboard()
            else:
                keyboard = None # –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç
            send_message(chat_id, text, keyboard)

def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (long polling)") # <-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (long polling)")

    # --- –ó–ê–ü–£–°–ö –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô ---
    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    reminder_thread = threading.Thread(target=check_and_send_reminders, args=(send_message,), daemon=True) # daemon=True –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    reminder_thread.start()

    # --- –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ ---
    offset = load_offset()
    while True:
        try:
            url = f"{BASE_URL}/getUpdates"
            params = {"offset": offset + 1, "timeout": 30}
            response = requests.get(url, params=params)
            updates = response.json()

            if updates.get("ok"):
                for update in updates.get("result", []):
                    handle_update(update)
                    offset = update["update_id"]
                    save_offset(offset)
            else:
                logger.error(f"–û—à–∏–±–∫–∞ API: {updates}")

        except requests.exceptions.Timeout:
            logger.debug("–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ getUpdates.")
        except requests.exceptions.RequestException as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")
            time.sleep(10)
        except KeyboardInterrupt:
            logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
            break
        except Exception as e:
            logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            time.sleep(10)

    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ daemon=True)
    # reminder_thread.join()

if __name__ == '__main__':
    main()

---


=== combined.txt ===



=== config.txt ===

import os

from dotenv import load_dotenv

load_dotenv()

# --- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ ---
# __file__ - —ç—Ç–æ –ø—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É —Ñ–∞–π–ª—É (config.py).
# os.path.dirname(...) –ø–æ–ª—É—á–∞–µ—Ç –ø–∞–ø–∫—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –ª–µ–∂–∏—Ç config.py.
# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ config.py –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.
PROJECT_ROOT = os.path.dirname(os.path.abspath(__file__))

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ ---
BOT_TOKEN = os.getenv("BOT_TOKEN")

# --- –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–ø–µ—Ä—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π) ---
# os.path.join —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –∏ –∏–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DATABASE_PATH = os.path.join(PROJECT_ROOT, 'bot_database.db')

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–µ–ø–µ—Ä—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ) ---
# LOG_DIR —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –≤–Ω—É—Ç—Ä–∏ PROJECT_ROOT
LOG_DIR = os.path.join(PROJECT_ROOT, 'logs') # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –ª–æ–≥–æ–≤
LOG_FILE_SIZE = 2 * 1024 * 1024  # 2 –ú–ë –≤ –±–∞–π—Ç–∞—Ö

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≥–æ–¥—ã ---
DEFAULT_CITY = "Moscow"
WEATHER_TIME = "08:00"
MASTER_MESSAGE_TIME = "09:00"

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ---
REMINDER_DEFAULT_TIME = "23:55"


---


=== database.txt ===

import sqlite3
import os
from datetime import datetime # <-- –î–û–ë–ê–í–õ–ï–ù–û –¥–ª—è get_reminders_for_time_check
from config import DATABASE_PATH # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ DATABASE_PATH –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ config.py

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—É–∫–∞–∑—ã–≤–∞–µ–º –≤ config.py)
# DATABASE_PATH = os.getenv("DATABASE_PATH", "bot_database.db") # –ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ config.py

class DatabaseManager:
    def __init__(self, db_path):
        self.db_path = db_path
        self.init_tables()

    def get_connection(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö."""
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row # –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–æ–ª–æ–Ω–∫–∞–º –ø–æ –∏–º–µ–Ω–∏
        return conn

    def init_tables(self):
        """–°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç."""
        conn = self.get_connection()
        cursor = conn.cursor()

        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ (–¥–æ–±–∞–≤–ª–µ–Ω user_id)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS notes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                text TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞–¥–∞—á (–¥–æ–±–∞–≤–ª–µ–Ω user_id)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS tasks (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                text TEXT NOT NULL,
                deadline TEXT, -- –ë—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD HH:MM:SS'
                is_completed BOOLEAN DEFAULT 0, -- 0 = –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–æ, 1 = –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω user_id)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS reminders (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                text TEXT NOT NULL,
                remind_at TEXT NOT NULL, -- –í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD HH:MM:SS'
                is_recurring BOOLEAN DEFAULT 0, -- 0 = –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ, 1 = –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ–ø–µ—Ä—å –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        # –£–±–∏—Ä–∞–µ–º id=1, –¥–µ–ª–∞–µ–º user_id –æ—Å–Ω–æ–≤–Ω—ã–º –∫–ª—é—á–æ–º
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS settings (
                user_id INTEGER PRIMARY KEY, -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                main_city TEXT DEFAULT 'Moscow',
                daily_weather_time TEXT, -- HH:MM
                daily_weather_enabled BOOLEAN DEFAULT 0,
                master_message_time TEXT, -- HH:MM
                master_message_enabled BOOLEAN DEFAULT 0
            )
        ''')

        # –£–±–∏—Ä–∞–µ–º –≤—Å—Ç–∞–≤–∫—É –Ω–∞—á–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
        # cursor.execute('''
        #     INSERT OR IGNORE INTO settings (user_id, main_city, daily_weather_time, daily_weather_enabled, master_message_time, master_message_enabled)
        #     VALUES (1, 'Moscow', '08:00', 0, '09:00', 0)
        # ''')

        conn.commit()
        conn.close()

    # --- CRUD –¥–ª—è –ó–∞–º–µ—Ç–æ–∫ ---
    # –î–æ–±–∞–≤–ª—è–µ–º user_id –∫ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º
    def add_note(self, user_id, text):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("INSERT INTO notes (user_id, text) VALUES (?, ?)", (user_id, text))
        note_id = cursor.lastrowid
        conn.commit()
        conn.close()
        return note_id

    def get_all_notes(self, user_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ user_id
        cursor.execute("SELECT id, text, created_at FROM notes WHERE user_id = ? ORDER BY created_at DESC", (user_id,))
        rows = cursor.fetchall()
        notes = [{"id": row["id"], "text": row["text"], "created_at": row["created_at"]} for row in rows]
        conn.close()
        return notes

    def update_note(self, user_id, note_id, new_text): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        cursor.execute("UPDATE notes SET text = ? WHERE id = ? AND user_id = ?", (new_text, note_id, user_id))
        conn.commit()
        conn.close()

    def delete_note(self, user_id, note_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        cursor.execute("DELETE FROM notes WHERE id = ? AND user_id = ?", (note_id, user_id))
        conn.commit()
        conn.close()

    # --- CRUD –¥–ª—è –ó–∞–¥–∞—á ---
    def add_task(self, user_id, text, deadline=None):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("INSERT INTO tasks (user_id, text, deadline) VALUES (?, ?, ?)", (user_id, text, deadline))
        task_id = cursor.lastrowid
        conn.commit()
        conn.close()
        return task_id

    def get_all_tasks(self, user_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT id, text, deadline, is_completed, created_at FROM tasks WHERE user_id = ? ORDER BY created_at DESC", (user_id,))
        rows = cursor.fetchall()
        tasks = []
        for row in rows:
            tasks.append({
                "id": row["id"],
                "text": row["text"],
                "deadline": row["deadline"],
                "is_completed": bool(row["is_completed"]),
                "created_at": row["created_at"]
            })
        conn.close()
        return tasks

    def update_task(self, user_id, task_id, new_text=None, new_deadline=None, is_completed=None):
        conn = self.get_connection()
        cursor = conn.cursor()
        updates = []
        params = []

        if new_text is not None:
            updates.append("text = ?")
            params.append(new_text)
        if new_deadline is not None:
            updates.append("deadline = ?")
            params.append(new_deadline)
        if is_completed is not None:
            updates.append("is_completed = ?")
            params.append(int(is_completed))

        if updates:
            # –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–∏–µ WHERE –ø–æ user_id –∏ id
            sql = f"UPDATE tasks SET {', '.join(updates)} WHERE id = ? AND user_id = ?"
            params.extend([task_id, user_id])
            cursor.execute(sql, params)
            conn.commit()
        conn.close()

    def delete_task(self, user_id, task_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("DELETE FROM tasks WHERE id = ? AND user_id = ?", (task_id, user_id))
        conn.commit()
        conn.close()

    # --- CRUD –¥–ª—è –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ---
    def add_reminder(self, user_id, text, remind_at, is_recurring=False):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("INSERT INTO reminders (user_id, text, remind_at, is_recurring) VALUES (?, ?, ?, ?)", (user_id, text, remind_at, int(is_recurring)))
        reminder_id = cursor.lastrowid
        conn.commit()
        conn.close()
        return reminder_id

    def get_all_reminders(self, user_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT id, text, remind_at, is_recurring, created_at FROM reminders WHERE user_id = ? ORDER BY remind_at ASC", (user_id,))
        rows = cursor.fetchall()
        reminders = []
        for row in rows:
            reminders.append({
                "id": row["id"],
                "text": row["text"],
                "remind_at": row["remind_at"],
                "is_recurring": bool(row["is_recurring"]),
                "created_at": row["created_at"]
            })
        conn.close()
        return reminders

    # --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê ---
    def get_reminders_for_time_check(self, check_time): # <-- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –≤—Ä–µ–º—è remind_at –∫–æ—Ç–æ—Ä—ã—Ö <= check_time.
        """
        conn = self.get_connection()
        cursor = conn.cursor()
        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ remind_at <= check_time
        cursor.execute("SELECT id, user_id, text, remind_at, is_recurring, created_at FROM reminders WHERE remind_at <= ? ORDER BY remind_at ASC", (check_time.strftime('%Y-%m-%d %H:%M:%S'),))
        rows = cursor.fetchall()
        reminders = []
        for row in rows:
            reminders.append({
                "id": row["id"],
                "user_id": row["user_id"],
                "text": row["text"],
                "remind_at": row["remind_at"],
                "is_recurring": bool(row["is_recurring"]),
                "created_at": row["created_at"]
            })
        conn.close()
        return reminders

    def update_reminder_type(self, user_id, reminder_id, is_recurring): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("UPDATE reminders SET is_recurring = ? WHERE id = ? AND user_id = ?", (int(is_recurring), reminder_id, user_id))
        conn.commit()
        conn.close()

    def delete_reminder(self, user_id, reminder_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("DELETE FROM reminders WHERE id = ? AND user_id = ?", (reminder_id, user_id))
        conn.commit()
        conn.close()

    # --- CRUD –¥–ª—è –ù–∞—Å—Ç—Ä–æ–µ–∫ ---
    def get_settings(self, user_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM settings WHERE user_id = ?", (user_id,)) # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ user_id
        row = cursor.fetchone()
        if row:
            settings = {
                "main_city": row["main_city"],
                "daily_weather_time": row["daily_weather_time"],
                "daily_weather_enabled": bool(row["daily_weather_enabled"]),
                "master_message_time": row["master_message_time"],
                "master_message_enabled": bool(row["master_message_enabled"]),
            }
        else:
            # –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            settings = {
                "main_city": "Moscow",
                "daily_weather_time": "08:00",
                "daily_weather_enabled": False,
                "master_message_time": "09:00",
                "master_message_enabled": False,
            }
        conn.close()
        return settings

    def update_setting(self, user_id, key, value): # –î–æ–±–∞–≤–ª—è–µ–º user_id
        conn = self.get_connection()
        cursor = conn.cursor()
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º INSERT OR REPLACE –∏–ª–∏ INSERT ... ON CONFLICT –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—Å–æ–∑–¥–∞–Ω–∏—è
        # cursor.execute(f"INSERT OR REPLACE INTO settings (user_id, {key}) VALUES (?, ?)", (user_id, value))
        # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º UPDATE, –∏ –µ—Å–ª–∏ –æ–Ω –Ω–µ –æ–±–Ω–æ–≤–∏–ª –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏, –¥–µ–ª–∞–µ–º INSERT
        cursor.execute(f"UPDATE settings SET {key} = ? WHERE user_id = ?", (value, user_id))
        if cursor.rowcount == 0:
            # –ï—Å–ª–∏ UPDATE –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É–ª –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏, –∑–Ω–∞—á–∏—Ç –∑–∞–ø–∏—Å–∏ –Ω–µ –±—ã–ª–æ, –¥–µ–ª–∞–µ–º INSERT
            cursor.execute(f"INSERT INTO settings (user_id, {key}) VALUES (?, ?)", (user_id, value))
        conn.commit()
        conn.close()

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ config.py
from config import DATABASE_PATH
db_manager = DatabaseManager(DATABASE_PATH)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏
def get_db():
    return db_manager

---


=== datetime_parser.txt ===

# utils/datetime_parser.py (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¢–û–ß–ù–û —Ç–∞–∫)
from datetime import datetime, timedelta
from config import REMINDER_DEFAULT_TIME # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ config.py
import re

def parse_deadline(input_text, default_time_str=None):
    """
    –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –≤–≤–æ–¥–∞ –¥–µ–¥–ª–∞–π–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'DD.MM' –≤ 'YYYY-MM-DD HH:MM:SS'.
    –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞ –≤ —Ç–µ–∫—É—â–µ–º –≥–æ–¥—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥–æ–¥–∞.
    """
    if default_time_str is None:
        default_time_str = REMINDER_DEFAULT_TIME # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º—è –∏–∑ config.py

    # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è DD.MM
    match = re.match(r'^(\d{1,2})\.(\d{1,2})$', input_text.strip())
    if not match:
        return None # –§–æ—Ä–º–∞—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω

    day, month = map(int, match.groups())

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —á–∏—Å–ª–∞ –∏ –º–µ—Å—è—Ü–∞
    if not (1 <= day <= 31 and 1 <= month <= 12):
        return None

    # –†–∞–∑–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    try:
        default_hour, default_minute = map(int, default_time_str.split(':'))
    except ValueError:
        # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ config.py –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º 23:55
        default_hour, default_minute = 23, 55

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
    now = datetime.now()
    # –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç datetime –¥–ª—è –≤–≤–µ–¥—ë–Ω–Ω–æ–π –¥–∞—Ç—ã –≤ —Ç–µ–∫—É—â–µ–º –≥–æ–¥—É —Å –≤—Ä–µ–º–µ–Ω–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    deadline_this_year = datetime(now.year, month, day, default_hour, default_minute, 0)

    # –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞ –≤ —ç—Ç–æ–º –≥–æ–¥—É, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
    if deadline_this_year < now:
        deadline_this_year = deadline_this_year.replace(year=now.year + 1)

    return deadline_this_year.strftime('%Y-%m-%d %H:%M:%S')

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
if __name__ == "__main__":
    print(f"–°–µ–≥–æ–¥–Ω—è: {datetime.now()}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '24.10': {parse_deadline('24.10')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '01.01': {parse_deadline('01.01')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '32.13': {parse_deadline('32.13')}") # –ù–µ–≤–∞–ª–∏–¥–Ω–æ
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ 'invalid': {parse_deadline('invalid')}") # –ù–µ–≤–∞–ª–∏–¥–Ω–æ

---


=== logger_config.txt ===

import logging
import os
from config import LOG_FILE_SIZE, LOG_DIR  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ config.py

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –ª–æ–≥–æ–≤
LOG_FILE_1 = os.path.join(LOG_DIR, 'bot_log_1.log')
LOG_FILE_2 = os.path.join(LOG_DIR, 'bot_log_2.log')

class RotatingFileHandlerTwoFiles(logging.Handler):
    """
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª–æ–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —Ä–æ—Ç–∏—Ä—É–µ—Ç –º–µ–∂–¥—É –¥–≤—É–º—è —Ñ–∞–π–ª–∞–º–∏.
    """
    def __init__(self, filename1, filename2, max_bytes):
        super().__init__()
        self.filename1 = filename1
        self.filename2 = filename2
        self.max_bytes = max_bytes
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–∞–ø–∫–∞ logs —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        os.makedirs(os.path.dirname(filename1), exist_ok=True)
        os.makedirs(os.path.dirname(filename2), exist_ok=True)

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—Ç—Ä–∏–±—É—Ç stream –∫–∞–∫ None –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –≤ _get_current_file_to_write
        self.stream = None
        try:
            self.current_file = self._get_current_file_to_write()
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏
            self.stream = open(self.current_file, 'a', encoding='utf-8')
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–≥–µ—Ä–∞: {e}")
            raise # –ü–µ—Ä–µ–ø–æ–¥–Ω–∏–º–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∞ –±—ã–ª–∞ —è–≤–Ω–æ–π


    def _get_current_file_to_write(self):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –≤ –∫–∞–∫–æ–π —Ñ–∞–π–ª –ø–∏—Å–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º."""
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–Ω–∞—á–µ 0
        size1 = os.path.getsize(self.filename1) if os.path.exists(self.filename1) else 0
        size2 = os.path.getsize(self.filename2) if os.path.exists(self.filename2) else 0

        # –ï—Å–ª–∏ –æ–±–∞ —Ñ–∞–π–ª–∞ –ø—É—Å—Ç—ã–µ –∏–ª–∏ –æ–±–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ
        if size1 == 0 and size2 == 0:
            return self.filename1
        # –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –∏ –≤—Ç–æ—Ä–æ–π –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –ø–∏—à–µ–º –≤–æ –≤—Ç–æ—Ä–æ–π
        elif size1 >= self.max_bytes and size2 < self.max_bytes:
            return self.filename2
        # –ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–π —Ñ–∞–π–ª –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –∏ –ø–µ—Ä–≤—ã–π –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –ø–∏—à–µ–º –≤ –ø–µ—Ä–≤—ã–π
        elif size2 >= self.max_bytes and size1 < self.max_bytes:
            return self.filename1
        # –ï—Å–ª–∏ –æ–±–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω—ã, –æ—á–∏—â–∞–µ–º –ø–µ—Ä–≤—ã–π –∏ –ø–∏—à–µ–º —Ç—É–¥–∞
        elif size1 >= self.max_bytes and size2 >= self.max_bytes:
            with open(self.filename1, 'w', encoding='utf-8') as f: # –û—á–∏—â–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª
                pass
            return self.filename1
        # –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö, –µ—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –ø–∏—à–µ–º –≤ –ø–µ—Ä–≤—ã–π –Ω–µ–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã–π
        else:
            return self.filename1 if size1 < self.max_bytes else self.filename2

    def _rotate_file(self):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª, –∏ –µ—Å–ª–∏ –¥–∞ - –º–µ–Ω—è–µ—Ç."""
        if self.stream and os.path.getsize(self.current_file) >= self.max_bytes:
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫
            self.stream.close()
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
            if self.current_file == self.filename1:
                self.current_file = self.filename2
            else:
                self.current_file = self.filename1
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫
            self.stream = open(self.current_file, 'a', encoding='utf-8')

    def emit(self, record):
        """
        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
            self._rotate_file()
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            msg = self.format(record)
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –æ—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ç–æ–∫
            if self.stream: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ç–æ–∫ –æ—Ç–∫—Ä—ã—Ç
                self.stream.write(msg + '\n')
                self.stream.flush() # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä
        except Exception:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            self.handleError(record)

    def close(self):
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ç–æ–∫ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏."""
        if hasattr(self, 'stream') and self.stream: # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ –∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ
            self.stream.close()
        super().close()

def setup_logger():
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–≥–≥–µ—Ä —Å —Ä–æ—Ç–∞—Ü–∏–µ–π.
    """
    logger = logging.getLogger('TelegramBotLogger') # –ò–º—è –ª–æ–≥–≥–µ—Ä–∞
    logger.setLevel(logging.DEBUG) # –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

    # –°–æ–∑–¥–∞–µ–º –Ω–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    handler = RotatingFileHandlerTwoFiles(LOG_FILE_1, LOG_FILE_2, LOG_FILE_SIZE)

    # –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    handler.setFormatter(formatter)

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –ª–æ–≥–≥–µ—Ä—É
    logger.addHandler(handler)

    return logger

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ª–æ–≥–≥–µ—Ä–∞
bot_logger = setup_logger()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏
def get_logger():
    return bot_logger

---


=== notes.txt ===

# modules/notes.py
from logger_config import get_logger
from database import get_db

logger = get_logger()
db = get_db() # –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DatabaseManager

def get_all_notes(user_id):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        notes = db.get_all_notes(user_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ {len(notes)} –∑–∞–º–µ—Ç–æ–∫ –∏–∑ –ë–î –¥–ª—è user_id {user_id}.")
        return notes
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–æ–∫ –¥–ª—è user_id {user_id}: {e}")
        return []

def add_note(user_id, text):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    if not text or not text.strip():
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É —Å –ø—É—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è user_id {user_id}.")
        return None

    try:
        note_id = db.add_note(user_id, text.strip())
        logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞ (ID: {note_id}) –¥–ª—è user_id {user_id}.")
        return note_id
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ –¥–ª—è user_id {user_id}: {e}")
        return None

def update_note(user_id, note_id, new_text):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    if not new_text or not new_text.strip():
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É (ID: {note_id}) —Å –ø—É—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è user_id {user_id}.")
        return False

    try:
        db.update_note(user_id, note_id, new_text.strip())
        logger.info(f"–ó–∞–º–µ—Ç–∫–∞ (ID: {note_id}) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è user_id {user_id}.")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ (ID: {note_id}) –¥–ª—è user_id {user_id}: {e}")
        return False

def delete_note(user_id, note_id):
    """
    –£–¥–∞–ª—è–µ—Ç –∑–∞–º–µ—Ç–∫—É –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        db.delete_note(user_id, note_id)
        logger.info(f"–ó–∞–º–µ—Ç–∫–∞ (ID: {note_id}) —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è user_id {user_id}.")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ (ID: {note_id}) –¥–ª—è user_id {user_id}: {e}")
        return False

def format_notes_list(notes):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫ –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    if not notes:
        return "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫."

    formatted_lines = []
    for note in notes:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ note['text'] –Ω–µ None
        text_display = (note['text'] or "")[:100] # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ None
        formatted_lines.append(f"{note['id']}. {text_display}")

    return "\n".join(formatted_lines)

def get_note_text_by_id(user_id, note_id):
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    try:
        all_notes = db.get_all_notes(user_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        for note in all_notes:
            if note['id'] == note_id:
                return note['text']
        logger.warning(f"–ó–∞–º–µ—Ç–∫–∞ —Å ID {note_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è user_id {user_id}.")
        return None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ (ID: {note_id}) –¥–ª—è user_id {user_id}: {e}")
        return None


---


=== notes_handler.txt ===

# handlers/notes_handler.py
from logger_config import get_logger
from modules.notes import get_all_notes, add_note, update_note, delete_note, format_notes_list, get_note_text_by_id
from datetime import datetime

logger = get_logger()

def handle_notes_callback(data, chat_id, message_id, user_id, user_states, send_message_func, edit_message_text_func, get_notes_keyboard_func): # user_id —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∑–∞–º–µ—Ç–∫–∞–º–∏."""
    # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é –ó–ê–ú–ï–¢–û–ö (–Ω–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é!)
    if data == 'notes_menu':
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å –∑–∞–º–µ—Ç–∫–∞–º–∏ –¥–ª—è (user_id, chat_id)
        if user_states.get((user_id, chat_id)) and user_states[(user_id, chat_id)].startswith("waiting_for_note_"):
            user_states.pop((user_id, chat_id), None)
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ
            send_message_func(chat_id, "–î–µ–π—Å—Ç–≤–∏–µ —Å –∑–∞–º–µ—Ç–∫–æ–π –æ—Ç–º–µ–Ω–µ–Ω–æ.")
            logger.info(f"–î–µ–π—Å—Ç–≤–∏–µ —Å –∑–∞–º–µ—Ç–∫–æ–π –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫—É.")

    elif data.startswith("edit_note_"):
        note_id = int(data.split("_")[2])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_note_text_by_id
        note_text = get_note_text_by_id(user_id, note_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if note_text is not None:
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            user_states[(user_id, chat_id)] = f"waiting_for_note_edit_text_{note_id}"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏ —Å—Ç–∞—Ä—ã–º —Ç–µ–∫—Å—Ç–æ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∫–æ–¥–∞ (HTML <code>)
            escaped_text = _escape_html(note_text) # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML-—Å–∏–º–≤–æ–ª—ã –≤ —Å—Ç–∞—Ä–æ–º —Ç–µ–∫—Å—Ç–µ
            message_text = f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–º–µ—Ç–∫–∏ {note_id}:\n–¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç:\n<code>{escaped_text}</code>"
            send_message_func(chat_id, message_text, get_cancel_inline_keyboard_func("notes_menu"), parse_mode='HTML')
        else:
            send_message_func(chat_id, f"–ó–∞–º–µ—Ç–∫–∞ —Å ID {note_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_notes_menu
            _refresh_notes_menu(chat_id, user_states, send_message_func, get_notes_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data.startswith("delete_note_"):
        note_id = int(data.split("_")[2])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ delete_note
        success = delete_note(user_id, note_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if success:
            send_message_func(chat_id, f"–ó–∞–º–µ—Ç–∫–∞ —Å ID {note_id} —É–¥–∞–ª–µ–Ω–∞.")
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–¥–∞–ª–∏–ª –∑–∞–º–µ—Ç–∫—É (ID: {note_id}).")
        else:
            send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ —Å ID {note_id}.")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ (ID: {note_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_notes_menu
        _refresh_notes_menu(chat_id, user_states, send_message_func, get_notes_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data == 'add_note_prompt':
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_states[(user_id, chat_id)] = "waiting_for_note_text"
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –∏ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π "–û—Ç–º–µ–Ω–∞"
        send_message_func(chat_id, "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏:", get_cancel_inline_keyboard_func("notes_menu"))

    # elif data == 'notes_menu': # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã—à–µ
    #     _refresh_notes_menu(chat_id, user_states, edit_message_text_func, get_notes_keyboard_func, message_id=message_id, user_id=user_id)


def handle_notes_message_input(text, chat_id, user_id, user_states, send_message_func, edit_message_text_func, get_notes_keyboard_func): # user_id —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∑–∞–º–µ—Ç–æ–∫."""
    current_state = user_states.get((user_id, chat_id))

    if current_state == "waiting_for_note_text":
        if text.strip(): # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
            note_text = text
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ add_note
            note_id = add_note(user_id, note_text) # <--- –ò–ó–ú–ï–ù–ï–ù–û
            if note_id: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏–ª–∞—Å—å
                send_message_func(chat_id, f"–ó–∞–º–µ—Ç–∫–∞ '{note_text[:30]}...' –¥–æ–±–∞–≤–ª–µ–Ω–∞ (ID: {note_id}).")
                logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –¥–æ–±–∞–≤–∏–ª –∑–∞–º–µ—Ç–∫—É (ID: {note_id}).")
            else:
                send_message_func(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏.")
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
        else:
            send_message_func(chat_id, "–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", get_cancel_inline_keyboard_func("notes_menu"))
            return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è

        # –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (—É—Å–ø–µ—à–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –±—ã–ª –Ω–µ –ø—É—Å—Ç–æ–π) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –∑–∞–º–µ—Ç–æ–∫
        user_states.pop((user_id, chat_id), None) # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_notes_menu
        _refresh_notes_menu(chat_id, user_states, send_message_func, get_notes_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        return # –í—ã—Ö–æ–¥–∏–º

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏
    if current_state and current_state.startswith("waiting_for_note_edit_text_"):
        note_id = int(current_state.split("_")[-1]) # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ "waiting_for_note_edit_text_123"
        if text.strip(): # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ update_note
            success = update_note(user_id, note_id, text.strip()) # <--- –ò–ó–ú–ï–ù–ï–ù–û
            if success:
                send_message_func(chat_id, f"–ó–∞–º–µ—Ç–∫–∞ —Å ID {note_id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞.")
                logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ–±–Ω–æ–≤–∏–ª –∑–∞–º–µ—Ç–∫—É (ID: {note_id}).")
            else:
                send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ —Å ID {note_id}.")
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏ (ID: {note_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
        else:
            send_message_func(chat_id, "–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", get_cancel_inline_keyboard_func("notes_menu"))
            return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è

        # –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—É—Å–ø–µ—à–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –±—ã–ª –Ω–µ –ø—É—Å—Ç–æ–π) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –∑–∞–º–µ—Ç–æ–∫
        user_states.pop((user_id, chat_id), None) # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_notes_menu
        _refresh_notes_menu(chat_id, user_states, send_message_func, get_notes_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        return # –í—ã—Ö–æ–¥–∏–º

# ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ handlers/notes_handler.py, _refresh_notes_menu, _escape_html, set_cancel_keyboard_func) ...

def _refresh_notes_menu(chat_id, user_states, send_or_edit_func, get_keyboard_func, user_id): # –î–æ–±–∞–≤–ª—è–µ–º user_id
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é –∑–∞–º–µ—Ç–æ–∫."""
    # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_notes
    notes = get_all_notes(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
    notes_text = format_notes_list(notes)
    keyboard = get_keyboard_func(notes)
    # ... (–ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ...
    # –ü—Ä–∏–º–µ—Ä: send_or_edit_func(chat_id, notes_text, keyboard)
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è edit_message_text_func, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å message_id
    # send_or_edit_func(chat_id, message_id, notes_text, keyboard)

def _escape_html(text):
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –Ω–∞—Ä—É—à–∏—Ç—å HTML-—Ä–∞–∑–º–µ—Ç–∫—É."""
    if text is None:
        return ""
    return (text.replace("&", "&amp;")
                .replace("<", "<")
                .replace(">", ">"))

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–º–µ–Ω—ã, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–∑ bot.py
get_cancel_inline_keyboard_func = None
def set_cancel_keyboard_func(func):
    global get_cancel_inline_keyboard_func
    get_cancel_inline_keyboard_func = func

---


=== reminders.txt ===

# modules/reminders.py
from logger_config import get_logger
from database import get_db
from datetime import datetime

logger = get_logger()
db = get_db() # –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DatabaseManager

def get_all_reminders(user_id):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        reminders = db.get_all_reminders(user_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ {len(reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–∑ –ë–î –¥–ª—è user_id {user_id}.")
        return reminders
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è user_id {user_id}: {e}")
        return []

def add_reminder(user_id, text, remind_at, is_recurring=False):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    if not text or not text.strip():
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –ø—É—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è user_id {user_id}.")
        return None # –í–æ–∑–≤—Ä–∞—â–∞–µ–º None, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç

    try:
        reminder_id = db.add_reminder(user_id, text.strip(), remind_at, is_recurring) # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –ø–µ—Ä–µ–¥–∞—ë–º user_id
        logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (ID: {reminder_id}) –¥–ª—è user_id {user_id}.")
        return reminder_id
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è user_id {user_id}: {e}")
        return None

def update_reminder_type(user_id, reminder_id, is_recurring):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∏–ø –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ/–µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ) –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        db.update_reminder_type(user_id, reminder_id, is_recurring) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        type_str = "–µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ" if is_recurring else "–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ"
        logger.info(f"–¢–∏–ø –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder_id}) –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ {type_str} –¥–ª—è user_id {user_id}.")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder_id}) –¥–ª—è user_id {user_id}: {e}")
        return False

def delete_reminder(user_id, reminder_id):
    """
    –£–¥–∞–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        db.delete_reminder(user_id, reminder_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        logger.info(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (ID: {reminder_id}) —É–¥–∞–ª–µ–Ω–æ –¥–ª—è user_id {user_id}.")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder_id}) –¥–ª—è user_id {user_id}: {e}")
        return False

def get_reminder_by_id(user_id, reminder_id):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/–∏–∑–º–µ–Ω–µ–Ω–∏—è.
    """
    try:
        all_reminders = db.get_all_reminders(user_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        for reminder in all_reminders:
            if reminder['id'] == reminder_id:
                return reminder
        logger.warning(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å ID {reminder_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è user_id {user_id}.")
        return None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder_id}) –¥–ª—è user_id {user_id}: {e}")
        return None

# –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
def format_reminders_list(reminders):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    if not reminders:
        return "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."

    formatted_lines = []
    for reminder in reminders:
        recurring_marker = " [–ï–ñ–ï–î–ù–ï–í–ù–û]" if reminder['is_recurring'] else ""
        # –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤, –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ
        text_display = (reminder['text'] or "")[:100] # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ None
        formatted_lines.append(f"{reminder['id']}. {text_display} ({reminder['remind_at']}){recurring_marker}")

    return "\n".join(formatted_lines)


---


=== reminders_datetime_parser.txt ===

# utils/reminders_datetime_parser.py
from datetime import datetime, timedelta
from config import REMINDER_DEFAULT_TIME # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ config.py
import re

def parse_reminder_time(input_text, default_time_str=None):
    """
    –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ 'YYYY-MM-DD HH:MM:SS'.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
    - '5 –º–∏–Ω' / '1 —á' (–æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
    - '18:15' (—Å–µ–≥–æ–¥–Ω—è –≤ 18:15)
    - '–∑–∞–≤—Ç—Ä–∞ 10:00' (–∑–∞–≤—Ç—Ä–∞ –≤ 10:00)
    - '15 –æ–∫—Ç—è–±—Ä—è' (15 –æ–∫—Ç—è–±—Ä—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞ –≤ REMINDER_DEFAULT_TIME)
    """
    if default_time_str is None:
        default_time_str = REMINDER_DEFAULT_TIME # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º—è –∏–∑ config.py

    input_text = input_text.strip().lower()
    now = datetime.now()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç "HH:MM" (—Å–µ–≥–æ–¥–Ω—è)
    time_match = re.search(r'\b(\d{1,2}):(\d{2})\b', input_text)
    if time_match:
        hour, minute = map(int, time_match.groups())
        if 0 <= hour <= 23 and 0 <= minute <= 59:
            reminder_time = now.replace(hour=hour, minute=minute, second=0, microsecond=0)
            # –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ –∑–∞–≤—Ç—Ä–∞
            if reminder_time <= now:
                reminder_time = reminder_time + timedelta(days=1)
            return reminder_time.strftime('%Y-%m-%d %H:%M:%S')

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç "–∑–∞–≤—Ç—Ä–∞ HH:MM"
    tomorrow_match = re.search(r'\b–∑–∞–≤—Ç—Ä–∞\s+(\d{1,2}):(\d{2})\b', input_text)
    if tomorrow_match:
        hour, minute = map(int, tomorrow_match.groups())
        if 0 <= hour <= 23 and 0 <= minute <= 59:
            reminder_time = (now + timedelta(days=1)).replace(hour=hour, minute=minute, second=0, microsecond=0)
            return reminder_time.strftime('%Y-%m-%d %H:%M:%S')

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç "N –º–∏–Ω" / "N —á"
    # –ò—â–µ–º —á–∏—Å–ª–æ —Å –µ–¥–∏–Ω–∏—Ü–µ–π –≤—Ä–µ–º–µ–Ω–∏ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ —Å—Ç—Ä–æ–∫–∏
    time_delta_match = re.search(r'(\d+)\s*(–º–∏–Ω|—á|—á–∞—Å)', input_text)
    if time_delta_match:
        value, unit = time_delta_match.groups()
        value = int(value)
        if unit in ['–º–∏–Ω']:
            delta = timedelta(minutes=value)
        elif unit in ['—á', '—á–∞—Å']:
            delta = timedelta(hours=value)
        else:
            return None # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞

        reminder_time = now + delta
        return reminder_time.strftime('%Y-%m-%d %H:%M:%S')

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç "DD –º–µ—Å—è—Ü" (–≤ REMINDER_DEFAULT_TIME)
    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –º–µ—Å—è—Ü–µ–≤ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤)
    months = {
        '—è–Ω–≤–∞—Ä—è': 1, '—Ñ–µ–≤—Ä–∞–ª—è': 2, '–º–∞—Ä—Ç–∞': 3, '–∞–ø—Ä–µ–ª—è': 4, '–º–∞—è': 5, '–∏—é–Ω—è': 6,
        '–∏—é–ª—è': 7, '–∞–≤–≥—É—Å—Ç–∞': 8, '—Å–µ–Ω—Ç—è–±—Ä—è': 9, '–æ–∫—Ç—è–±—Ä—è': 10, '–Ω–æ—è–±—Ä—è': 11, '–¥–µ–∫–∞–±—Ä—è': 12
    }
    # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è DD –º–µ—Å—è—Ü–∞
    date_match = re.search(r'(\d{1,2})\s+(' + '|'.join(months.keys()) + ')', input_text)
    if date_match:
        day, month_str = date_match.groups()
        day = int(day)
        month = months[month_str]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —á–∏—Å–ª–∞ –∏ –º–µ—Å—è—Ü–∞
        if not (1 <= day <= 31):
            return None

        try:
            default_hour, default_minute = map(int, default_time_str.split(':'))
        except ValueError:
            default_hour, default_minute = 23, 55

        # –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç datetime –¥–ª—è –≤–≤–µ–¥—ë–Ω–Ω–æ–π –¥–∞—Ç—ã –≤ —Ç–µ–∫—É—â–µ–º –≥–æ–¥—É —Å –≤—Ä–µ–º–µ–Ω–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        reminder_time = datetime(now.year, month, day, default_hour, default_minute, 0)

        # –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞ –≤ —ç—Ç–æ–º –≥–æ–¥—É, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
        if reminder_time < now:
            reminder_time = reminder_time.replace(year=now.year + 1)

        return reminder_time.strftime('%Y-%m-%d %H:%M:%S')

    # –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–æ—à—ë–ª
    return None

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
if __name__ == "__main__":
    print(f"–°–µ–π—á–∞—Å: {datetime.now()}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '5 –º–∏–Ω': {parse_reminder_time('5 –º–∏–Ω')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '1 —á': {parse_reminder_time('1 —á')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '18:15': {parse_reminder_time('18:15')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '–∑–∞–≤—Ç—Ä–∞ 10:00': {parse_reminder_time('–∑–∞–≤—Ç—Ä–∞ 10:00')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '24 –æ–∫—Ç—è–±—Ä—è': {parse_reminder_time('24 –æ–∫—Ç—è–±—Ä—è')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ '01 —è–Ω–≤–∞—Ä—è': {parse_reminder_time('01 —è–Ω–≤–∞—Ä—è')}")
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ 'invalid': {parse_reminder_time('invalid')}") # –ù–µ–≤–∞–ª–∏–¥–Ω–æ

---


=== reminders_handler.txt ===

# handlers/reminders_handler.py
from logger_config import get_logger
from modules.reminders import get_all_reminders, add_reminder, update_reminder_type, delete_reminder, get_reminder_by_id, format_reminders_list
from utils.reminders_datetime_parser import parse_reminder_time
from datetime import datetime

logger = get_logger()

def handle_reminders_callback(data, chat_id, message_id, user_id, user_states, send_message_func, edit_message_text_func, get_reminders_keyboard_func): # user_id —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏."""
    if data.startswith("toggle_reminder_type_"):
        reminder_id = int(data.split("_")[3])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_reminder_by_id
        reminder_info = get_reminder_by_id(user_id, reminder_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if reminder_info is not None:
            new_type = not reminder_info['is_recurring']
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ update_reminder_type
            success = update_reminder_type(user_id, reminder_id, new_type) # <--- –ò–ó–ú–ï–ù–ï–ù–û
            if success:
                type_text = "–µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ" if new_type else "–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ"
                send_message_func(chat_id, f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å ID {reminder_id} —Ç–µ–ø–µ—Ä—å {type_text}.")
                logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∏–∑–º–µ–Ω–∏–ª —Ç–∏–ø –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder_id}) –Ω–∞ {type_text}.")
            else:
                send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å ID {reminder_id}.")
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
        else:
            send_message_func(chat_id, f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å ID {reminder_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_reminders_menu
        _refresh_reminders_menu(chat_id, user_states, send_message_func, get_reminders_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data.startswith("delete_reminder_"):
        reminder_id = int(data.split("_")[2])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ delete_reminder
        success = delete_reminder(user_id, reminder_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if success:
            send_message_func(chat_id, f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å ID {reminder_id} —É–¥–∞–ª–µ–Ω–æ.")
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–¥–∞–ª–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (ID: {reminder_id}).")
        else:
            send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å ID {reminder_id}.")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (ID: {reminder_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_reminders_menu
        _refresh_reminders_menu(chat_id, user_states, send_message_func, get_reminders_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data == 'add_reminder_prompt':
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ —Ñ–æ—Ä–º–∞—Ç–∞–º
        formats_help = (
            "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –≤—Ä–µ–º—è –≤ –æ–¥–Ω–æ–º –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:\n"
            "‚Ä¢ 5 –º–∏–Ω\n"
            "‚Ä¢ 1 —á\n"
            "‚Ä¢ 18:15 (—Å–µ–≥–æ–¥–Ω—è –≤ 18:15)\n"
            "‚Ä¢ –∑–∞–≤—Ç—Ä–∞ 10:00\n"
            "‚Ä¢ 15 –æ–∫—Ç—è–±—Ä—è (–≤ 23:55, –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫)\n"
        )
        send_message_func(chat_id, formats_help)
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–æ–≤–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        user_states[(user_id, chat_id)] = "waiting_for_reminder_text_and_time"
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –∏ –≤—Ä–µ–º—è
        send_message_func(chat_id, "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –≤—Ä–µ–º—è:", get_cancel_inline_keyboard_func("reminders_menu"))

    elif data == 'reminders_menu':
        # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
        if user_states.get((user_id, chat_id)) and user_states[(user_id, chat_id)].startswith("waiting_for_reminder_"):
            user_states.pop((user_id, chat_id), None)
            send_message_func(chat_id, "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.")
            logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫—É.")

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_reminders_menu
        _refresh_reminders_menu(chat_id, user_states, edit_message_text_func, get_reminders_keyboard_func, user_id, message_id=message_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

def handle_reminders_message_input(text, chat_id, user_id, user_states, send_message_func, edit_message_text_func, get_reminders_keyboard_func): # user_id —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    current_state = user_states.get((user_id, chat_id))

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    if current_state == "waiting_for_reminder_text_and_time":
        # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Ä–µ–º—è –∏–∑ –≤—Å–µ–≥–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        parsed_time = parse_reminder_time(text)
        if parsed_time:
            # –í—Å—ë, —á—Ç–æ –∏–¥—ë—Ç –¥–æ –≤—Ä–µ–º–µ–Ω–∏, —Å—á–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç–æ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            # –≠—Ç–æ –≥—Ä—É–±–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏
            # –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ —É–±–µ—Ä—ë–º –≤—Ä–µ–º—è –∏–∑ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏
            import re
            # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ HH:MM
            time_pattern = r'\b\d{1,2}:\d{2}\b'
            # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è "N –º–∏–Ω" / "N —á" / "N —á–∞—Å"
            time_delta_pattern = r'\b\d+\s*(–º–∏–Ω|—á|—á–∞—Å)\b'
            # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è "DD –º–µ—Å—è—Ü"
            date_pattern = r'\b\d{1,2}\s+(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)\b'
            # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è "–∑–∞–≤—Ç—Ä–∞ HH:MM"
            tomorrow_pattern = r'\b–∑–∞–≤—Ç—Ä–∞\s+\d{1,2}:\d{2}\b'

            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
            full_pattern = f'({time_pattern}|{time_delta_pattern}|{date_pattern}|{tomorrow_pattern})$'
            match = re.search(full_pattern, text.strip(), re.IGNORECASE)
            if match:
                time_part = match.group(1).strip()
                text_part = text[:match.start()].strip()
                if not text_part:
                    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—ë, –∫—Ä–æ–º–µ –≤—Ä–µ–º–µ–Ω–∏
                    text_part = text.replace(time_part, '').strip()
            else:
                # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                text_part = text.strip()

            if text_part:
                reminder_text = text_part
                # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ add_reminder
                reminder_id = add_reminder(user_id, reminder_text, parsed_time) # <--- –ò–ó–ú–ï–ù–ï–ù–û
                if reminder_id:
                    send_message_func(chat_id, f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ '{reminder_text[:30]}...' –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞ {parsed_time}.")
                    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –¥–æ–±–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (ID: {reminder_id}) –Ω–∞ {parsed_time}.")
                else:
                    send_message_func(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.")
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
            else:
                send_message_func(chat_id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", get_cancel_inline_keyboard_func("reminders_menu"))
                return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è
        else:
            send_message_func(chat_id, f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: '{text}'. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", get_cancel_inline_keyboard_func("reminders_menu"))
            return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è

        # –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (—É—Å–ø–µ—à–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
        user_states.pop((user_id, chat_id), None) # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_reminders_menu
        _refresh_reminders_menu(chat_id, user_states, send_message_func, get_reminders_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        return # –í—ã—Ö–æ–¥–∏–º

def _refresh_reminders_menu(chat_id, user_states, send_or_edit_func, get_keyboard_func, user_id, message_id=None): # –î–æ–±–∞–≤–ª—è–µ–º user_id
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_reminders
    reminders = get_all_reminders(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
    reminders_text = format_reminders_list(reminders)
    keyboard = get_keyboard_func(reminders)
    if message_id:
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        send_or_edit_func(chat_id, message_id, reminders_text, keyboard)
    else:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        send_or_edit_func(chat_id, reminders_text, keyboard)

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–º–µ–Ω—ã, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–∑ bot.py
get_cancel_inline_keyboard_func = None
def set_cancel_keyboard_func(func):
    global get_cancel_inline_keyboard_func
    get_cancel_inline_keyboard_func = func

---


=== tasks.txt ===

# modules/tasks.py
from logger_config import get_logger
from database import get_db
from datetime import datetime

logger = get_logger()
db = get_db() # –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DatabaseManager

def get_all_tasks(user_id):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        tasks = db.get_all_tasks(user_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ {len(tasks)} –∑–∞–¥–∞—á –∏–∑ –ë–î –¥–ª—è user_id {user_id}.")
        return tasks
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á –¥–ª—è user_id {user_id}: {e}")
        return []

def add_task(user_id, text, deadline=None):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    if not text or not text.strip():
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É —Å –ø—É—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è user_id {user_id}.")
        return None # –í–æ–∑–≤—Ä–∞—â–∞–µ–º None, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç

    try:
        task_id = db.add_task(user_id, text.strip(), deadline) # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –ø–µ—Ä–µ–¥–∞—ë–º user_id
        logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (ID: {task_id}) –¥–ª—è user_id {user_id}.")
        return task_id
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –¥–ª—è user_id {user_id}: {e}")
        return None

def update_task(user_id, task_id, new_text=None, new_deadline=None, is_completed=None):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –∑–∞–¥–∞—á–∏ –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å
    if new_text is None and new_deadline is None and is_completed is None:
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É (ID: {task_id}) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è user_id {user_id}.")
        return False

    try:
        db.update_task(user_id, task_id, new_text=new_text, new_deadline=new_deadline, is_completed=is_completed) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        logger.info(f"–ó–∞–¥–∞—á–∞ (ID: {task_id}) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è user_id {user_id}.")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ (ID: {task_id}) –¥–ª—è user_id {user_id}: {e}")
        return False

def delete_task(user_id, task_id):
    """
    –£–¥–∞–ª—è–µ—Ç –∑–∞–¥–∞—á—É –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    try:
        db.delete_task(user_id, task_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        logger.info(f"–ó–∞–¥–∞—á–∞ (ID: {task_id}) —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è user_id {user_id}.")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ (ID: {task_id}) –¥–ª—è user_id {user_id}: {e}")
        return False

def get_task_by_id(user_id, task_id):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ –ø–æ ID –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    try:
        all_tasks = db.get_all_tasks(user_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        for task in all_tasks:
            if task['id'] == task_id:
                return task
        logger.warning(f"–ó–∞–¥–∞—á–∞ —Å ID {task_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è user_id {user_id}.")
        return None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ (ID: {task_id}) –¥–ª—è user_id {user_id}: {e}")
        return None

def check_overdue_tasks(user_id):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID —Ç–∞–∫–∏—Ö –∑–∞–¥–∞—á.
    """
    try:
        all_tasks = db.get_all_tasks(user_id) # –ü–µ—Ä–µ–¥–∞—ë–º user_id
        now = datetime.now()
        today_start = now.replace(hour=0, minute=0, second=0, microsecond=0)
        today_end = now.replace(hour=23, minute=59, second=59, microsecond=999999)
        overdue_task_ids = []
        for task in all_tasks:
            if not task['is_completed'] and task['deadline']:
                try:
                    deadline_dt = datetime.fromisoformat(task['deadline'])
                    if today_start <= deadline_dt <= today_end:
                        overdue_task_ids.append(task['id'])
                except ValueError:
                    # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                    logger.warning(f"–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–µ–¥–ª–∞–π–Ω–∞ –¥–ª—è –∑–∞–¥–∞—á–∏ {task['id']} (user {user_id}): {task['deadline']}")
        logger.debug(f"–ù–∞–π–¥–µ–Ω–æ {len(overdue_task_ids)} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è user {user_id}: {overdue_task_ids}")
        return overdue_task_ids
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è user {user_id}: {e}")
        return []

# –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
def format_tasks_list(tasks):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    –ü–æ–º–µ—á–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏.
    """
    if not tasks:
        return "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á."

    formatted_lines = []
    now = datetime.now()
    for task in tasks:
        status = "‚úÖ" if task['is_completed'] else "‚è≥"
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–∫—É
        is_overdue = False
        deadline_dt = None
        if task['deadline']:
            try:
                deadline_dt = datetime.fromisoformat(task['deadline'])
                if not task['is_completed'] and deadline_dt < now:
                    is_overdue = True
            except ValueError:
                # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                logger.warning(f"–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–µ–¥–ª–∞–π–Ω–∞ –¥–ª—è –∑–∞–¥–∞—á–∏ {task['id']}: {task['deadline']}")

        overdue_marker = " [–ü–†–û–°–†–û–ß–ï–ù–û]" if is_overdue else ""
        deadline_str = f" ({deadline_dt.strftime('%d.%m.%Y %H:%M')})" if deadline_dt else " (–±–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞)"
        # –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤, –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ
        text_display = (task['text'] or "")[:100] # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ None
        formatted_lines.append(f"{status} {task['id']}. {text_display}{deadline_str}{overdue_marker}")

    return "\n".join(formatted_lines)


---


=== tasks_handler.txt ===

# handlers/tasks_handler.py
from logger_config import get_logger
from modules.tasks import get_all_tasks, add_task, update_task, delete_task, get_task_by_id, format_tasks_list, check_overdue_tasks
from utils.datetime_parser import parse_deadline
from datetime import datetime

logger = get_logger()

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã "–û—Å—Ç–∞–≤–∏—Ç—å...", –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–∑ bot.py ---
get_keep_current_text_keyboard_func = None
def set_keep_current_text_keyboard_func(func):
    global get_keep_current_text_keyboard_func
    get_keep_current_text_keyboard_func = func

get_keep_current_deadline_keyboard_func = None
def set_keep_current_deadline_keyboard_func(func):
    global get_keep_current_deadline_keyboard_func
    get_keep_current_deadline_keyboard_func = func

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–º–µ–Ω—ã, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–∑ bot.py
get_cancel_inline_keyboard_func = None
def set_cancel_keyboard_func(func):
    global get_cancel_inline_keyboard_func
    get_cancel_inline_keyboard_func = func

def handle_tasks_callback(data, chat_id, message_id, user_id, user_states, send_message_func, edit_message_text_func, get_tasks_keyboard_func): # user_id —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∑–∞–¥–∞—á–∞–º–∏."""
    if data.startswith("edit_task_"):
        task_id = int(data.split("_")[2])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_task_by_id
        task_info = get_task_by_id(user_id, task_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if task_info is not None:
            # –ù–∞—á–∏–Ω–∞–µ–º –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            user_states[(user_id, chat_id)] = f"waiting_for_task_text_edit_{task_id}"
            old_text = task_info['text']
            escaped_text = _escape_html(old_text) # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML-—Å–∏–º–≤–æ–ª—ã –≤ —Å—Ç–∞—Ä–æ–º —Ç–µ–∫—Å—Ç–µ
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏ —Å—Ç–∞—Ä—ã–º —Ç–µ–∫—Å—Ç–æ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∫–æ–¥–∞ (HTML <code>)
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode='HTML'
            message_text = f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏ {task_id}:\n–¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç:\n<code>{escaped_text}</code>"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π "–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç"
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∏–∑ bot.py
            if get_keep_current_text_keyboard_func:
                keyboard = get_keep_current_text_keyboard_func(task_id, "tasks_menu")
            else:
                # –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Ç–º–µ–Ω–æ–π
                keyboard = get_cancel_inline_keyboard_func("tasks_menu")
            send_message_func(chat_id, message_text, keyboard, parse_mode='HTML')
        else:
            send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ —Å ID {task_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
            _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data.startswith("keep_current_text_"):
        task_id = int(data.split("_")[3])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_task_by_id
        task_info = get_task_by_id(user_id, task_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if task_info:
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –¥–µ–¥–ª–∞–π–Ω–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç
            user_states[(user_id, chat_id)] = f"waiting_for_task_deadline_edit_{task_id}"
            current_deadline = task_info['deadline']
            deadline_str = current_deadline if current_deadline else "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            message_text = f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –¥–µ–¥–ª–∞–π–Ω –¥–ª—è –∑–∞–¥–∞—á–∏ {task_id} (–Ω–∞–ø—Ä–∏–º–µ—Ä, '24.10'):\n–¢–µ–∫—É—â–∏–π –¥–µ–¥–ª–∞–π–Ω: {deadline_str}"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π "–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É"
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∏–∑ bot.py
            if get_keep_current_deadline_keyboard_func:
                keyboard = get_keep_current_deadline_keyboard_func(task_id, "tasks_menu")
            else:
                # –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Ç–º–µ–Ω–æ–π
                keyboard = get_cancel_inline_keyboard_func("tasks_menu")
            send_message_func(chat_id, message_text, keyboard, parse_mode=None)
        else:
            send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ —Å ID {task_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
            _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data.startswith("keep_current_deadline_"):
        task_id = int(data.split("_")[3])
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è—è
        user_states.pop((user_id, chat_id), None)
        send_message_func(chat_id, f"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ {task_id} –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
        _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data.startswith("toggle_task_status_"):
        task_id = int(data.split("_")[3])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_task_by_id
        task_info = get_task_by_id(user_id, task_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if task_info is not None:
            new_status = not task_info['is_completed']
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ update_task
            success = update_task(user_id, task_id, is_completed=new_status) # <--- –ò–ó–ú–ï–ù–ï–ù–û
            if success:
                status_text = "–≤—ã–ø–æ–ª–Ω–µ–Ω–∞" if new_status else "–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
                send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ —Å ID {task_id} –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ {status_text}.")
                logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∏–∑–º–µ–Ω–∏–ª —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ (ID: {task_id}) –Ω–∞ {status_text}.")
            else:
                send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ —Å ID {task_id}.")
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ (ID: {task_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
        else:
            send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ —Å ID {task_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
        _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data.startswith("delete_task_"):
        task_id = int(data.split("_")[2])
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ delete_task
        success = delete_task(user_id, task_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if success:
            send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ —Å ID {task_id} —É–¥–∞–ª–µ–Ω–∞.")
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–¥–∞–ª–∏–ª –∑–∞–¥–∞—á—É (ID: {task_id}).")
        else:
            send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ —Å ID {task_id}.")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ (ID: {task_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
        _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    elif data == 'add_task_prompt':
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
        user_states[(user_id, chat_id)] = "waiting_for_task_text"
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç
        send_message_func(chat_id, "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏:", get_cancel_inline_keyboard_func("tasks_menu"))

    elif data == 'tasks_menu':
        # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
        if user_states.get((user_id, chat_id)) and user_states[(user_id, chat_id)].startswith("waiting_for_task_"):
            user_states.pop((user_id, chat_id), None)
            # –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            temp_text_key_add = (user_id, chat_id, 'temp_task_text_for_add')
            user_states.pop(temp_text_key_add, None)
            send_message_func(chat_id, "–î–µ–π—Å—Ç–≤–∏–µ —Å –∑–∞–¥–∞—á–µ–π –æ—Ç–º–µ–Ω–µ–Ω–æ.")
            logger.info(f"–î–µ–π—Å—Ç–≤–∏–µ —Å –∑–∞–¥–∞—á–µ–π –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫—É.")

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
        _refresh_tasks_menu(chat_id, user_states, edit_message_text_func, get_tasks_keyboard_func, user_id, message_id=message_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

def handle_tasks_message_input(text, chat_id, user_id, user_states, send_message_func, edit_message_text_func, get_tasks_keyboard_func): # user_id —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á."""
    current_state = user_states.get((user_id, chat_id))

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    if current_state == "waiting_for_task_text":
        if text.strip():
            task_text = text.strip()
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –¥–µ–¥–ª–∞–π–Ω–∞
            user_states[(user_id, chat_id)] = "waiting_for_task_deadline_after_add"
            # –°–û–•–†–ê–ù–Ø–ï–ú –í–†–ï–ú–ï–ù–ù–û –¢–ï–ö–°–¢ –ó–ê–î–ê–ß–ò
            user_states[(user_id, chat_id, 'temp_task_text_for_add')] = task_text
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ –¥–µ–¥–ª–∞–π–Ω
            send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ '{task_text[:30]}...' –¥–æ–±–∞–≤–ª–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –¥–µ–¥–ª–∞–π–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, '24.10') –∏–ª–∏ '–Ω–µ—Ç', —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞.", get_cancel_inline_keyboard_func("tasks_menu"))
        else:
            send_message_func(chat_id, "–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", get_cancel_inline_keyboard_func("tasks_menu"))

    elif current_state == "waiting_for_task_deadline_after_add":
        deadline = None
        if text.lower() != '–Ω–µ—Ç':
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä—Å–µ—Ä –¥–∞—Ç
            parsed_deadline = parse_deadline(text)
            if parsed_deadline:
                deadline = parsed_deadline
            else:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ bot.py –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã "–û—Å—Ç–∞–≤–∏—Ç—å..." –∏–ª–∏ –æ—Ç–º–µ–Ω—ã
                keyboard = get_cancel_inline_keyboard_func("tasks_menu")
                send_message_func(chat_id, f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–µ–¥–ª–∞–π–Ω–∞: '{text}'. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24.10). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", keyboard)
                return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É —Å –¥–µ–¥–ª–∞–π–Ω–æ–º (–∏–ª–∏ –±–µ–∑)
        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        temp_text_key = (user_id, chat_id, 'temp_task_text_for_add')
        saved_text = user_states.get(temp_text_key)
        if not saved_text:
             logger.error(f"–û—à–∏–±–∫–∞: —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ–¥–ª–∞–π–Ω–∞ –¥–ª—è {user_id}, {chat_id}")
             send_message_func(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
             user_states.pop((user_id, chat_id), None)
             user_states.pop(temp_text_key, None) # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É–¥–∞–ª–∏–ª–∏
             # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
             _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
             return

        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ add_task
        task_id = add_task(user_id, saved_text, deadline=deadline) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        if task_id:
            send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ (ID: {task_id}).")
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –¥–æ–±–∞–≤–∏–ª –∑–∞–¥–∞—á—É (ID: {task_id}).")
        else:
            send_message_func(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏.")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")

        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        user_states.pop((user_id, chat_id), None)
        user_states.pop(temp_text_key, None)
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
        _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞—á–∏
    elif current_state and current_state.startswith("waiting_for_task_text_edit_"):
        task_id = int(current_state.split("_")[-1])
        if text.strip():
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –¥–µ–¥–ª–∞–π–Ω–∞
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_task_by_id
            task_info = get_task_by_id(user_id, task_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
            if not task_info:
                 send_message_func(chat_id, f"–ó–∞–¥–∞—á–∞ —Å ID {task_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                 user_states.pop((user_id, chat_id), None)
                 # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
                 _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
                 return

            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ update_task
            success = update_task(user_id, task_id, new_text=text.strip()) # <--- –ò–ó–ú–ï–ù–ï–ù–û
            if success:
                # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –¥–µ–¥–ª–∞–π–Ω–∞
                user_states[(user_id, chat_id)] = f"waiting_for_task_deadline_edit_{task_id}"
                current_deadline = task_info['deadline'] # –ë–µ—Ä—ë–º –¥–µ–¥–ª–∞–π–Ω –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
                deadline_str = current_deadline if current_deadline else "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
                message_text = f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –¥–µ–¥–ª–∞–π–Ω –¥–ª—è –∑–∞–¥–∞—á–∏ {task_id} (–Ω–∞–ø—Ä–∏–º–µ—Ä, '24.10'):\n–¢–µ–∫—É—â–∏–π –¥–µ–¥–ª–∞–π–Ω: {deadline_str}"
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π "–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É"
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∏–∑ bot.py
                if get_keep_current_deadline_keyboard_func:
                    keyboard = get_keep_current_deadline_keyboard_func(task_id, "tasks_menu")
                else:
                    # –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Ç–º–µ–Ω–æ–π
                    keyboard = get_cancel_inline_keyboard_func("tasks_menu")
                send_message_func(chat_id, message_text, keyboard, parse_mode=None)
                logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ–±–Ω–æ–≤–∏–ª —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ (ID: {task_id}).")
            else:
                send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞—á–∏ —Å ID {task_id}.")
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞—á–∏ (ID: {task_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –∑–∞–¥–∞—á
                user_states.pop((user_id, chat_id), None)
                # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
                _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ bot.py –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã "–û—Å—Ç–∞–≤–∏—Ç—å..." –∏–ª–∏ –æ—Ç–º–µ–Ω—ã
            keyboard = get_cancel_inline_keyboard_func("tasks_menu")
            send_message_func(chat_id, "–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", keyboard)
            return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–¥–ª–∞–π–Ω–∞ –∑–∞–¥–∞—á–∏
    elif current_state and current_state.startswith("waiting_for_task_deadline_edit_"):
        task_id = int(current_state.split("_")[-1])
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä—Å–µ—Ä –¥–∞—Ç
        parsed_deadline = parse_deadline(text)
        if parsed_deadline:
            # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ update_task
            success = update_task(user_id, task_id, new_deadline=parsed_deadline) # <--- –ò–ó–ú–ï–ù–ï–ù–û
            if success:
                send_message_func(chat_id, f"–î–µ–¥–ª–∞–π–Ω –∑–∞–¥–∞—á–∏ —Å ID {task_id} –æ–±–Ω–æ–≤–ª—ë–Ω.")
                logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ–±–Ω–æ–≤–∏–ª –¥–µ–¥–ª–∞–π–Ω –∑–∞–¥–∞—á–∏ (ID: {task_id}).")
            else:
                send_message_func(chat_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–µ–¥–ª–∞–π–Ω–∞ –∑–∞–¥–∞—á–∏ —Å ID {task_id}.")
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–µ–¥–ª–∞–π–Ω–∞ –∑–∞–¥–∞—á–∏ (ID: {task_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ bot.py –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã "–û—Å—Ç–∞–≤–∏—Ç—å..." –∏–ª–∏ –æ—Ç–º–µ–Ω—ã
            if get_keep_current_deadline_keyboard_func:
                keyboard = get_keep_current_deadline_keyboard_func(task_id, "tasks_menu")
            else:
                # –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Ç–º–µ–Ω–æ–π
                keyboard = get_cancel_inline_keyboard_func("tasks_menu")
            send_message_func(chat_id, f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–µ–¥–ª–∞–π–Ω–∞: '{text}'. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24.10). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", keyboard, parse_mode=None)
            return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è

        # –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–¥–ª–∞–π–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –∑–∞–¥–∞—á
        user_states.pop((user_id, chat_id), None)
        # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ _refresh_tasks_menu
        _refresh_tasks_menu(chat_id, user_states, send_message_func, get_tasks_keyboard_func, user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û

def _refresh_tasks_menu(chat_id, user_states, send_or_edit_func, get_keyboard_func, user_id, message_id=None): # –î–æ–±–∞–≤–ª—è–µ–º user_id
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é –∑–∞–¥–∞—á."""
    # –ü–µ—Ä–µ–¥–∞—ë–º user_id –≤ get_all_tasks
    tasks = get_all_tasks(user_id) # <--- –ò–ó–ú–ï–ù–ï–ù–û
    tasks_text = format_tasks_list(tasks)
    keyboard = get_keyboard_func(tasks)
    if message_id:
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        send_or_edit_func(chat_id, message_id, tasks_text, keyboard)
    else:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        send_or_edit_func(chat_id, tasks_text, keyboard)

def _escape_html(text):
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –Ω–∞—Ä—É—à–∏—Ç—å HTML-—Ä–∞–∑–º–µ—Ç–∫—É."""
    if text is None:
        return ""
    return (text.replace("&", "&amp;")
                .replace("<", "<")
                .replace(">", ">"))


---
